计算机网络
==================

本文为中国大学mooc上华南理工大学[计算机网络课程](https://www.icourse163.org/learn/SCUT-1002700002?tid=1002883005#/learn/announce)的学习笔记

#目录
-----------------

## 第一章 概述

-------------

1.3 常用的基本概念

计算机网络：

    使用单一技术的自主计算机的互联集合
    要求单台计算机的独立自主性

互联网络：

    计算机网络的互相连接

WWW：

    是信息资源的网络，资源、资源标识和协议三部分支持了www的运作。

拓扑:

    信道的分布方式，有总线型、星型、环形、树形和全联通/网状等
    互联网中主要用到总线型和星型来连接

协议(Protocal)：

    一系列规则和约定的规范性描述，它控制了网络中的设备之间如何进行信息的交换。如TCP/IP协议

数字带宽：

    单位时间内流经的信息总量
    eg：100Mbps 即 1s内流经100M b的数据，等于100M / 8 = 12.5MB/s

吞吐量：

    指的是实际的、可测的带宽
    受到网络设备、传输的数据类型、网络拓扑、用户数量、用户计算机、服务器等多方面影响

点到点：

    信源机和信宿机之间的通信由一段一段直接相连的机器间的通信组成，机器间的直接连接叫做点到点连接。

端到端：

    信源机和信宿机之间直接通信，好像拥有一条直接相连的线路。

计算机网络根据区域大小分为：PAN(1m以内，键鼠等),LAN,MAN,WAN,Internet

1.4 参考模型

ISO-OSI标准：

    Application 提供服务
    Presentation 数据的解释
    Session 保证应用之间的会话
    Transport 端到端连接
    Network 选择最优路径连接端
    Data Link 物理寻址，网络拓扑，错误提示，流控制
    Physical 只传递2进制比特流

TCP/IP标准：

    Application
    Transport
    Internet
    Network Access

1.5 信号的传输

发送方：

    封装/打包
    协议数据单元(PDU protocol data unit)
    每一层添加一个报头
    信息 -- 数据流 -- 数据段 -- 分组 -- 帧 -- 比特流
    实体：每一层中活动的元素，可能是硬件或者软件，负责实现本层的功能
    接口：下一层提供接口供上一层调用；协议：与用于同层之间

PDU

    物理层 数据位(bit)
    数据链路层 数据帧(frame)
    网络层 数据包(packet)
    传输层 数据段(segment)
    应用层 数据(data)

接收方：

    解封装/解包


## 第二章 物理层

-------------
1.1 概述

物理层的主要功能：

    提供透明的比特流传输
    将封装好的01数据流从一个地方传输到另一个地方

物理层的4大特征：

    机械特征：指明接口所有接线器的形状、尺寸、引脚数和排列等
    电气特征：指明在接口电缆各条线上出现的电压的范围
    功能特征：指明某条线上出现的某一电平的电压表示何种意义
    规程特征：指明对于不同功能各种事件的出现顺序

什么是物理带宽？

    信号的传输由很多不同频率的分量传输组成，由于高频分量的不等量衰减，接收到的信号其实是衰减和失真的。
    一般来说从0-fc(截止频率)这一频段，信号不会发生明显衰减
    物理带宽指的是传输过程中频率不会发生明显衰减的频率范围
    它是一种物理特征，通常取决于材料、厚度、长度等

数字带宽和物理带宽的区别？

    奈奎斯特定理：在无噪声信道中，当频率为B Hz，信号电平为V级，则最大传输速率为2Blog2(V) bps
    V为信号的电平级数，在二进制中只有0和1两级
    即：以每秒高于2B次的速率对线路采样是无意义的
    V取决于采样，例如每个采样16bit，则V为2^16

    香农定理：在有噪声信道中，频率为B Hz，信噪比为S/N时，最大传输速率为Blog2(1+S/N) bps
    噪声分贝值与信噪比的换算：
    db = 10log10(S/N),如果30db噪声，则信噪比为1000


模拟信号和数字信号：

    模拟信号对应时域上的取值是连续的
    数字信号则是离散的
    代表不同离散值的基本波形成为码元

1.2 有导向的传输介质

引导性传输介质：

    也较有线传输介质，主要有铜线和光纤
    非引导性传输介质：卫星、无线电等

铜传输介质主要包括哪些？

    同轴电缆(包括中心铜导体、绝缘塑料、屏蔽网、外部绝缘层)
    基带同轴电缆用于数字传输，宽带同轴电缆用于模拟传输
    双绞线(由两根具有绝缘层的铜导线，按一定密度逆时针绞合得到)
    一般地，绞距越小，传输性能越好

非屏蔽双绞线有什么特点？用于何处？

    非屏蔽双绞线(UTP unshielded twisted pair)：成本低，尺寸小，易于安装，但易受干扰，传输距离在100m左右
    数字带宽：10-100Mbps
    就是一般的网线，由4对8根组成

    屏蔽双绞线(STP shielded twisted pair)：加了屏蔽层，可以抗EMI/RFI干扰，成本高，安装麻烦，距离100m，10-100Mbps

    网屏式双绞线(ScTP screened twisted pair)：一对绞外面无绝缘层，折中的选择

使用UTP：
    
    百兆网使用2对，分别实现上下行
    千兆网使用所有的4对
    1 white
    2 orange
    3 white/green
    4 blue
    5 white/blue
    6 green
    7 white/brown
    8 brown
    1&2用于下行，3&6用于上行

光纤有何特点？主要用在哪里？

    光纤传输重量轻、损耗低、传输距离远、不受电磁干扰、防止窃听、带宽大，但昂贵且容易破损

单模光纤和多模光纤
    
    光纤由纤芯玻璃、玻璃覆盖层和外部包套组成
    单模：使用激光，纤芯细，高带宽，长距离
    多模：使用LED，纤芯粗，低带宽，短距离

1.3 复用技术

让多用户共享同一根信道

FDM频分多路复用(frequency division multiplexing):

    将频谱分为若干段，每个用户占据一段来传输信号，相邻信号之间有保护带
    正交FDM(orthogonal FDM)实现了复用，用在802.11，4G中

WDM波分多路复用(wavelength division multiplexing):

    本质和FDM一样，在光纤上复用

TDM时分多路复用：

    用户轮流使用通道，广泛用于telephone/cellular系统
    Statistic TDM 统计时分多路复用，利用率可提高2-4倍，较复杂，用于ATM

CDMA扩展频谱技术：

    每个用户有唯一的码片序列，码片是正交的，可以同时传输，用于3G通信
    信号到达源后需要先进行解析

1.4 调制技术

什么时候需要调制？

    调制使用信号来传输比特，分为baseband transmission(基带传输)--直接将数据比特转化为信号和passband transmission(通带传输)通过调节信号的振幅、相位和频率来传输信号，特点是信号占据了以载波信号频率为中心的一段频带

基带传输：
    
    线路编码发送样本，一个样本包含1个或者多个比特
    直接传输
    不归零逆转(1在比特时间内跳转，0不跳转，例如从高电平跳转到低电平表示1，反之表示0)
    曼彻斯特编码(每个比特时间跳转一次，效率为50%)
    4B/5B跳转(4bit的数据由5bit表示)

调幅、调相、调频的原理：

信号星座：
    
    不同的基本调制方法的组合
    2^n个相位角度，则每个码元(承载信息的基本信号单位)最多包含n个比特

波特率/采样率/符号率：
    
    波特率是1s时间内传输的码元个数，也叫作码率
    它还是每s内信号变化的次数
    比特率与波特率：C = Blog2(n) n表示电平数(允许的状态数)
    在格子架编码调制(TCM)中，信号星座中有些格点用于降低调制错误，故而会降低比特率

1.5 公共交换电话网络PSTN(public switched telephone network)

PSTN：

    方便的已有通信设施
    包含：本地回路(调制技术,模拟线路)、干线(复用技术,数字光纤)、交换(话音接驳)

调制解调器：

    Modem,引入一个正弦波来传输信号(振幅、频率、相位),位于计算机与PSTN最后一英里之内，用于将计算机产生的位序列转化为载波输出，或者相反
    (V.90标准)56kbps的调制解调器：电话线路频率约为4k Hz,采样频率为8k Hz,每个码元传输8bit,其中1bit用于控制错误,则传输速率为8k * 7 = 56kbps
    xdsl技术：使用了本地回路的全部物理带宽(256 - 6)*4khz,达到1.1Mhz的传输速率
    现在已经实行了光纤到户(FTTH fiber to the home)

Codec：

    干线上使用，多路复用，端局的设备，可将模拟信号和数字信号互相转化
    PCM：脉冲编码调制，用于将模拟信号转化为数字信号

T1光纤：
    
    可以处理24路信号的复用：
    每个码元包含193bit数据  24 * 8bit + 1bit(framing) = 193bit
    使用时分多路(TDM)技术，间隔为125μs，传输速率为
    193bit / 125μs = 1.544Mbps
    通过高级复用将若干T1并为T2..T3..T4..增加传输速率
    E1线路可以处理32路复用，为256bit / 125μs = 2.048Mbps

交换技术：

    电路交换(circuit switching)：数据传输前建立一条端到端的通路，要求多个交换局提供连接
    报文交换(message switching)：数据一次发送，只要下一站空闲，即可发送到下一站，无需提前建立连接，但要求中转站存储较大
    分组交换(packet switching)：又叫做包交换，限制了分组大小，允许存入中转站内存中，后发可能先至

1.6 物理层设备

收发器(transceiver):

    是transmitter和reciver的简称，将一种形式的信号转化为另一种形式
    RJ-45-AUI RJ-45-BNC RJ-45-opticle

中继器(repeater)：

    信号再生，不可过滤

集线器(hub)：

    多端口的中继器，放大和再生信号，不可过滤

冲突：
    
    更多的用户争抢共享资源发生的问题
    冲突域值数据包发生冲突的网络区域，一层设备的使用增大了冲突域，现今已经很少使用了。

## 第三章 数据链路层

-------------

3.1 概述

数据链路层：

    为网络层提供良好的服务接口，保证数据传输的有效、可靠性，处理传输错误，进行流量控制(基于速率/反馈)

成帧法：

    成帧：物理层处理的是比特流，数据流处理的是帧
    成帧方法有字符计数法、字节填充的标志字节法、比特填充的标志比特法、物理层编码违例法。

字节填充的标志字节法：

    每一帧使用一些特殊字符(flag byte)开始/结束
    缺点是依赖于8位字节，而且容易在帧界造成混淆，可以使用转义字节控制

比特填充的标志比特法：

    法则1：以01111110作为帧开头
    法则2：传输连续多个1时，每个5个1补1个0，即011111110 -- 0111110110
    如果一个帧未被正确接收，当扫描到01111110时即可开始再一次的同步

物理层编码违例法：

    采用冗余编码技术
    -- 在采用曼彻斯特编码的数据流中，可以将连续高电平或低电平作为帧开始/结束
    -- 在4B/5B编码中，以32bit表示16bit，可以将不传输数据的部分用于标记


3.2 差错处理概述

差错的类型：

    单个错误：分散在各块
    突发错误：集中在某个块，通常利用处理单个错误的方法处理突发错误

纠错与检错：

    纠错：发现错误并恢复(用于无线网络中)
    检错：发现错误并请求重发

海明距离：

    码字：包含数据位和检错位的n位单元
    海明距离是两个码字不同位的个数，如100001 和 111111 的海明距离为4

    全部码字的海明距离：任意两个码字之间海明距离的最小值

    海明距离与检错：海明距离d+1的编码能检出d位错误

    例如奇偶校验：00 01 10 11 经过奇偶校验之后就是000 011 101 110，
    如果有码字001，则为非法码字，故出错了

    海明距离与纠错：海明距离为2d+1的编码，只能纠正d位差错

    海明距离增大，则纠错能力增加，但合法的码字减少了，从而降低了传输效率

3.3 纠一位错的海明码

冗余位：

    冗余位个数r和数据位长度m之间满足 (m + r + 1 <= 2^r)
    检验位和数据位的位置：检验位位于编号为2的整数次幂处，如1、2、4、8、16...位处。每一个检验位进行的都是奇校验或偶校验

纠正方法：

    定义计数器count = 0
    依次校验各个检验位，如果出错则将count增加对应的位置编号，最后如果count ！= 0则表明出错了，将第count位的结果改变即可

3.4 检错码

检错码：

    目的：纠错需要较多的冗余位，信道利用率不高，故在局域网中，检错码使用较多
    主要有：
    奇偶校验码(检一位错) -- 检验位 = 数据位的模二(异或)和运算
    互联网校验 
    循环冗余校验(CRC)

循环冗余校验：

    k bit/帧的数据用k-1次多项式表示
    根据不同标准，将码字进行编码：
    1. 选择标准如CRC32，多项式为G(x),阶数为r
    2. 将数据帧后面添加r个0
    3. 采用模二除法(使用除法的方式，每一位均采用异或运算即1-1=0, 0-0=0, 0-1=1, 1-0=1)，将得到的数据帧异或除以G(x)，得到余数
    4. 将数据帧模二减去余数，发送出去

    接收方：
    1. 检测接收帧是否能被G(x)整除，如果整除则表明传输无误
    2. 有余数，说明出现错误，重传

3.5 三个单工协议

接口类型：

    发送： from_network_layer, to_physical_layer
    接收： from_physical_layer, to_network_layer
    等待时间: wait_for_event, 包括frame_arrival, cksum_err, timeout
    Timer定时器: start_timer, stop_timer, start_ack_timer, stop_ack_timer (后二为捎带确认定时器) 

无限制的单工协议：

    前提：单向发送、缓存空间无穷大、处理时间忽略不计、信道不会损坏及丢帧
    乌托邦形式的协议

```c
// sender
while(true){
    from_network_layer(&buffer);
    s.info = buffer;
    to_physical_layer(&s);
}

// receiver
while(true){
    wait_for_event(&event);
    from_physical_layer(&r);
    to_network_layer(&r.info);
}
```

单工停-等协议：

    解决了要求缓存空间无限大的假设
    解决方案：接收方收到帧后返回一个哑帧，此时发送下一帧

```c
// sender
while(true){
    from_network_layer(&buffer);
    s.info = buffer;
    to_physical_layer(&s);
    wait_for_event(&event); /*等待返回*/
}

// receiver
while(true){
    wait_for_event(&event);
    from_physical_layer(&r);
    to_network_layer(&r.info);
    to_physical_layer(&S) /*向物理层发送一个哑帧，然后返回*/
}
```

有噪声(错误)信道的单工协议：
    
    ARQ-PAR： automatic repeat request/positive acknowledgement with retransmission
    采用了定时器防止丢帧死锁
    设置了一个定时器，如果在结束之前收到确认帧，则没有问题，否则重新发送帧
    对每一个帧确定了唯一序列号，防止重复处理帧

效率较高的方法：

    全双工、捎带确认、批发数据

3.6 滑窗协议

如何提高信道利用率？

    全双工、捎带确认、批量发送数据(协议4-6) --- 管道化技术
    两个窗口：
    发送窗口(对应发送消息还未确认的帧的序号)
    接收窗口(对应着期望接受的帧的序号)

```c
// 窗口协议的主要内容

void Protocal4(void){
    seq_nr next_frame_to_send = 0;
    seq_nr frame_expected = 0;
    frame r, s;
    packet buffer;
    event_type event;

    from_network_layer(&buffer);
    s.info = buffer;
    s.seq = next_frame_to_send;
    s.ack = 1 - frame_expected;
    to_physical_layer(&s); /*从物理层发送信息*/
    start_timer(s.seq);

    while(true){
        wait_for_event(&event);
        if(event == frame_arrival){
            from_physical_layer(&r); /*从物理层提取信息*/
            if(r.seq == frame_expected){
                to_network_layer(&r.info); /*移动接收窗口*/
                inc(frame_expected); /*收到对方的捎带信息*/
            }
            if(r.ack == next_frame_to_send){
                from_network_layer(&buffer); /*更新buffer*/
                inc(next_frame_to_send); /*更新捎带信息*/
            }
        }
        s.info = buffer;
        s.seq = next_frame_to_send;
        s.ack = 1 - frame_expected;
        to_physical_layer(&s);
        start_timer(s.seq);
    }
}
...
```

异常：

    1. 对重复帧的差错控制
    2. 同步开始发送过程的差错控制
    信道利用率：k/(k+bR) k:每帧大小 b:传输速率 R:双程延迟时间
    1位序列号只有0和1,信道利用率不高
    如果增加滑动窗口大小到W，则利用率变为W倍

如何找到合适的W值？

    信道上的容量：一帧从发送方传递到接收方期间可容纳的帧数量
    带宽延迟积：BD = 传输速率 * 单程延迟时间
    窗口值W <= 2*BD/k + 1

如何控制传输错误：

    1. 回退n帧，出错帧之后的部分重传
    2. 选择性重传，只选择出错的帧重传

3.7 回退n帧

工作原理：
    
    发送窗口为n，接收窗口为1
    接收方策略：丢弃错帧，后续帧也丢弃
    发送方策略：将发送帧缓存起来，重发出错帧及之后的帧

    回退n帧的基本概念：
    1. 定义序列号seq的取值范围和滑动窗口大小w
    2. 发送方连续发送直至窗口满
    3. 接收方窗口为1,对出错帧不确认(引发超时)
    4. 发送方超时重传，从未被确认的帧开始
    eg: 如果0-7为seq取值范围，w为7，如果第2帧出现错误，后续3-7返回的ack值为1
    
累计确认：

    对n号帧的确认，暗含对第n-1、n-2...等帧的确认，可以删除这些在发送方中的缓存

确定回退n帧的窗口数：

    发送方的发送窗口数w <= 序列号个数-1
    eg: 用3bit表示序列号，则w最大为7

3.8 选择性重传

基本概念：

    接收窗口存储差错帧后续的所有正确帧
    发送方只重传差错帧
    接收方接收重传帧，按正确顺序提交给网络层

NAK：
    
    出错帧超时才会引发重传，可以对此帧回送否定确认，使发放不再等到超时重传


协议4-6的比较：

|协议|发方窗口|收方窗口|说明|
|:--:|:--:|:--:|:--:|
|1bit的滑动窗口|1|1|-|
|回退n帧|<= MAX_SEQ|1|发方需要大缓存区,适用于信道出错率低|
|选择性重传|<= (MAX_SEQ+1)/2|<= 发方窗口|收方需要大缓存区,适用于信道质量不好|


## 第四章 介质访问控制子层

-------------

4.1 Mac子层概述

数据链路层被分为LLC(logical link access)子层(在上)和MAC(media access control)子层

信道通信方式：

    单播(one to one)
    广播(one to everyone of the whole) --- 局域网中采用
    组播(one to a group)

介质访问控制做什么？

    解决两个以上站点同时请求占用信道的问题
    在多路访问信道上确定下一个使用者

分配方式：

    静态分配：FDM、TDM等，资源以等分形式来分，有浪费，延迟时间增加，适用于用户数量较少、流量大且稳定的情况
    动态分配：MAP(multiple access protocol)协议

MAP协议分类：

    随机访问协议：
        站点争用信道，可能发生冲突
        ALOHA协议、CSMA协议、CSMA/CD协议(以太网采用)
    受控访问协议：
        站点被分配占用信道，无冲突

4.2 ALOHA协议

纯ALOHA协议：

    吞吐率：在单帧发送时间t内发送成功的帧数 0 < S < 1
    网络负载：在单帧时间内通信站发送的帧的平均值 G >= S
    帧发送成功的概率P0 = S / G

    工作原理：
        任何一个站点都在帧生成后立即发送，并通过信号的反馈检测信道，已确定是否发送成功
        如果发送失败，在随机延迟后再次发送
    冲突危险期为2个帧时(首尾相冲，浪费2个帧时)
    信道利用率 S 最大为18.6%，此时 G 为50%

分隙ALOHA协议:

    分隙是将时间分为时隙(时间片)，帧的发送必须在时隙的开始
    冲突只会浪费一个帧时t
    信道利用率 S 最大为36.8%，此时 G 为100%

4.3 CSMA协议(carrier sense multiple access 载波多路侦听)

CSMA协议：一种侦听/发送策略

    * 非持续式：
        1.经侦听,介质空闲开始发送;2.介质忙则等待一个随机事件
        等待时间内造成浪费
    * 1-持续：
        1.经侦听,介质空闲则发送;2.介质忙则持续侦听,一旦空闲立即发送;3.如果冲突,等待一个随机时间开始步骤1
        延迟时间小于非持续式,但如果两个以上的站等待发送,一旦介质空闲立即冲突
    * p-持续：
        每次侦听若介质空闲,以P的概率发送
        1-持续是P-持续的特例

冲突窗口：

    发生冲突时间的上限，即从发送到接收到冲突时间的上限，数值上等于最远两站传播时间的2倍，即2t
    Slot time = 2 * (t + tphy + N*t中继器)

CSMA/CD协议
    
    所有工作站在发送时也接收自己的信号，检测发送的情况，一旦收到的发送的不一致，则表明发生了冲突。
    发送站感知冲突后立即停止发送，并发送一个简短的jam阻塞信号，通知各站点发生了冲突，本站和各站点等待一个随机时间后再按照此协议继续发送。

冲突检测：

    冲突窗口为2t
    冲突检测的要求：
        1. 时隙宽度 = 冲突窗口
        2. 发送有效帧时间 >= 冲突窗口

4.4 以太网概述

以太网是CSMA/CD协议的实现
采用曼彻斯特编码，从高电平到低电平为1，反之为0

经典以太网：

    使用CSMA/CD协议和二进制指数后退算法
    二进制指数后退算法：
    冲突后的等待时间：时隙为51.2μs，第i次冲突，等待的间隔从(0~2^i-1)*51.2μs中随机选择
    优化方法：把成功发送后的第一个时隙留给接收方，防止确认帧冲突

交换式以太网：

    使用交换机(switch)取代和集线器(hub)成为星型拓扑的中心节点
    干线上仍使用总线拓扑

|速度|类型|协议|形式|编码|
|:--:|:--:|:--:|:--:|:--:|
|10M|经典|802.3|10base2 10base-T|曼彻斯特|
|100M|交换式|802.3u|100baseTX 100baseFX(光纤)|4B/5B|
|1G|交换式|802.3z|||

以太网的特点：

    简单性和灵活性
    易于维护
    支持TCP/IP协议，互联容易
    善于借鉴
    (STM和FDDI无法兼容以太网，需要改变帧格式)

4.5 以太网帧格式

以太网包括了物理层和数据链路层

IEEE802.3协议和以太网协议：

    IEEE802.3  带宽1~10Mbps  持续的CSMA/CD协议的局域网标准
    以太网协议与IEEE802.3的帧结构不同
    MAC地址每个设备唯一,xx-xx-xx-xx-xx-xx,前三位根据公司分配,MAC表示时 - 可以换成 : 或者 .

802.3帧结构：

    先导字段 + 帧开始标记 + 目的地址 + 源地址 + 数据长度 + 数据 + 校验和
    62bit         11        6Byte    6Byte    2Byte  46~1500B  4B
    
    最短帧长度为64Byte，帧开始用10101011表示
    检验使用CMC32循环冗余校验

以太网帧结构：

    先导字段 + 帧开始标记 + 目的地址 + 源地址 + 数据类型 + 数据 + 校验和
    62bit         10        6Byte    6Byte    2Byte  46~1500B  4B

    帧开始用10101010表示

区别802.3帧和以太帧：

    1. 帧开始标记
    2. 如果数据长度/类型字段的值小于等于1536(0x600),则为802.3帧,反之即为以太帧

为何最短帧长度为64Byte?

    CSMA/CD协议要求 最短帧的发送时间 >= 2*时隙 (=冲突窗口)
    在10Mbps局域网中，时隙t = 51.2μs
    最短帧长度为10Mbps * t / 8 = 64Byte
    如果一帧不足64Byte，可以填充到64Byte

4.6 二层交换基本原理

二层交换：
    
    使用网桥，连接各个LAN

网桥：

    工作在DLL层，通过检查MAC地址做出转发帧的决策
    * 通过透明的网桥(transparent bridges)，可以将各个不同的LAN连接在一起，硬件和软件不需要做任何变化
    * 透明的网桥工作在混杂模式(promiscuous mode)，接收所有跟他关联的LAN的帧
    * 当一个帧到达网桥，它必须做出丢弃(discard)或者转发(forward)的决策
    * 决策是通过网桥内部一张MAC地址表查找得到的

网桥工作原理：

    * 当一帧到达时，网桥启动如下算法：
        如果源Mac和目的Mac相同，丢弃这一帧
        如果源Mac和目的Mac不同，转发这一帧
        如果目的Mac未知，广播该帧
    * 每一帧到达，上述算法均执行一次

扩散：

    * 网桥初始MAC地址表是空的
    * 通过泛洪算法将帧从除来的LAN的所有LAN转发出去
    * 逆向学习 学习帧来的那个LAN,将其写入MAC地址表

MAC表的维护：

    * 无论何时,凡是往MAC表中输入记录,都打上时间戳
    * 到达帧的源地址在表中已有记录，则更新时间戳
    * 网桥周期性地扫描表，将超时的记录删除
    <img/>

交换机相比于中继器：

|功能|网桥|中继器|
|:--:|:--:|:--:|
|再生信号|Y|Y|
|连接采用不同Mac协议的网段|Y|N|
|根据帧头物理地址转发帧|Y|N|
|隔离冲突域|Y|N|
|丢弃损坏帧|Y|N|

集线器是物理层设备，只负责数据的传输，没有过滤功能
交换机是二层设备，有过滤的功能

4.7 生成树协议

冗余拓扑：

    一个LAN由多个网桥转发出去，可以应对单点故障的问题
    环路造成的问题：
    * 多帧传送 <img/>
    * 广播风暴 <img/>
    * Mac地址库不稳定 <img/>

生成树协议(Spanning tree protocol)：

    形成物理上的环路、逻辑上的无环路(可能不是最优的)
    STP的运作：
    * 每个网络有一个根网桥
    * 每个网桥有一个根端口
    * 每个网段有一个指定端口
    * 非指定端口不被使用，但是会保持侦听，如果某个指定端口出现故障，非指定端口将被启用

4.8 虚拟局域网

VLAN：

    二层交换机可以隔离冲突域，但是不能隔离广播域
    * 一个VLAN对应一个广播域
    * 有了VLAN，可以使用二层交换机实现广播域的划分
    * 当一个VLAN跨越几个交换机时，使用802.1Q穿越连接交换机的干线

VLAN实现技术：

    * 基于端口(最常用)
    * 基于三层协议
    * 基于Mac地址

帧标记法：

    依据IEEE802.1Q标准，使用VLAN ID标记帧
    在一帧的source address和length之间加入一个tag，标记VLAN ID

4.9 二层设备

二层设备包括网卡、网桥、交换机

网卡：

    网卡是第二层(主要)和第一层的设备，主要功能有：
    命名 提供一个独有的Mac地址
    成帧
    Mac 为介质访问控制提供策略
    再生信号

交换机：

    交换机每个端口是一个冲突域，每个VLAN是一个广播域。 
    交换机内部有驳接开关，可以在两台工作站之间建立直接连接。

交换模式：

    存储转发  帧全部存储、进行校验之后转发，可靠性高但速度慢
    直通交换(贯穿)  读取到目的地址后直接转发，可靠性低
    无分片交换  读取64Byte即转发，消除了碎片帧的影响，提高了准确性

## 第五章 网络层

-------------

5.1 网络层概述

网络层：

    使用网络访问层/数据链路层接口，为传输层提供服务
    网络层需要封装源数据、找到目的机并找到一根好的路径(路由)

源和目的之间的网络：

|比较项目|数据报子网|虚电路子网|
|:--:|:--:|:--:|
|建立电路|不需要(面向无连接)|需要(面向连接)|
|地址信息|每个分组有完整SA和DA|每个VC有很短的VC号码(用于识别不同连接)|
|状态信息|路由器不保留任何连接状态信息|每个VC都要求路由器建立表项|
|路由|每个分组独立选择路由|每个分组沿确定VC时确定的路由|
|路由器失效影响|只有系统崩溃时丢失分组|终止|
|服务质量和拥塞控制|难以实现|采用提前给VC分配资源的方法，容易实现|

5.2 IP地址

IP(internet protocol)的任务：

    提供一种尽力而为的把数据从源端传递到接收端的服务
    封装的格式：IP分组
    标识收发数据机：IP地址

IP地址的分类

|分类|前缀|固定/非固定字节|最高字节范围|主机数|
|:--:|:--:|:--:|:--:|:--:|
|A|0|1/3|0~127|2^24-2(1600W)|
|B|10|2/2|128~191|2^16-2(6.5W)|
|C|110|3/1|192~223|254|

保留IP地址：

    * D类(224.0.0.0 ~ 239.0.0.0)和E类(240.0.0.0 ~ 254.0.0.0)
    * 网络地址0.0.0.0
    * 广播地址255.255.255.255
    * 127.0.0.0 本机
    * 127.0.0.1 本机，主要用于测试，就是“我自己”
    * 169.254.x.x 非正常网络，不能正常联网，由DHCP分配

私有地址(只能在局域网中使用)：

    A类中：10.x.x.x 
    127.x.x.x 用作循环测试
    B类中：172.16.0.0 -- 172.31.255.255
    169.254.x.x 非正常网络
    C类中：192.168.x.x

5.3 子网规划

子网规划的目的：

    * 局域网不断增长，越来越难于管理，必须将其划分为子网
    * 一个网络被划分为几个部分(子网),但从外部看来是一个整体(体现在路由器的路由表例上,外部的路由器只对应一条路由)
    * 主路由器(边界路由器)维护一张子网掩码表，以向不同的分组转发

子网规划：

    建立一个由网络、子网、主机构成的三级层次结构
    根据用户需求，划分合理数目和规模的子网

子网掩码：

    * 子网掩码由连续的1再加连续的0构成，可以表示为 255.0.0.0 的形式
    也可以表示为 /8 的形式
    * 主路由器根据按位与操作，找到目的子网
    * 路由器不需要记住全部主机的IP地址，缩减了路由器的规模
    * ABC三类网络的子网掩码分别是255.0.0.0  255.255.0.0  255.255.255.0

借位原则：

    * 从高位开始借
    * 主机域至少保留2位(全0位表示自机,全1位广播)

192.168.1.0网段的子网划分：

|子网掩码|对应IP地址|允许主机个数|
|:--:|:--:|:--:|
|255.255.255.0|192.168.1.0~63|62|
|255.255.255.64|192.168.1.64~127|62|
|255.255.255.128|192.168.1.128~191|62|
|255.255.255.192|192.168.1.192~255|62|

5.4 子网寻址

IP寻址和MAC寻址：

    IP寻址 -- 通过目的机的IP地址，找到目的机所在的网络
    MAC寻址 -- 根据目的机的Mac地址，找到目的机
    * 适用的网络范围：MAC寻址只适合小型网络
    * 所依赖的地址结构：MAC是平面地址，IP是结构化信息，携带了位置信息
    * 所处的OSI模型层数不同
    * 地址数目的不同
    * 格式不同

路由器处理分组的过程：

    网络层的PDU为分组
    路由器收到一个分组之后，根据目标网络，查找路由表，重新封装并转发

路由表：

    * 路由表(routing table)是路由器转发数据的依据
    * 主要包括目的网络地址(network address)、接口(interface)、代价(metric)、子网掩码(subnet mask)、网关(gateway)等
    * 除了路由表之外，路由器中还有一张ARP表，包含所有子网设备的IP-MAC映射
    * 路由器可能因厂家的不同而不同

5.5 IP分组

IP分组中的字段

    分为报头(20byte + 数据报选项)和数据

报头部分

|内容|大小|说明|
|:--:|:--:|:--:|
|协议版本|4bit|IPV4:0100 IPV6:0110|
|报头长度|4bit|以32bit为单位|
|服务类型|8bit|上层协议表明该分组的重要程度|
|数据报总长度|16bit|单位为字节|
|数据报标识号|16bit|当前分组的序列号，以便收方重组|
|标志/分片偏移|3bit/13bit|分组的分片号，以便收方重组|
|生存时间|8bit|Time To Live，一个计数器，TTL-1=0时分组被丢弃|
|用户协议|8bit|UDP:17 TCP:6|
|报头校验和|16bit|针对报头计算的互联网校验和，验证头部正确性|
|源点IP地址|32bit||
|目的点IP地址|32bit||
|数据报选项+填充|4byte的整数倍|不常用|

eg：使用wireshark抓取的报文

    Internet Protocol Version 4, Src: 111.177.3.32, Dst: 192.168.1.4
        0100 .... = Version: 4
        .... 0101 = Header Length: 20 bytes (5)
        Differentiated Services Field: 0x00 (DSCP: CS0, ECN: Not-ECT)
        Total Length: 52
        Identification: 0x0000 (0)
        Flags: 0x4000, Don't fragment
        Time to live: 56
        Protocol: TCP (6)
        Header checksum: 0x0e47 [validation disabled]
        [Header checksum status: Unverified]
        Source: 111.177.3.32
        Destination: 192.168.1.4

5.6 IPV6简介

IPV4存在的问题

    IP：网络层协议，用于规范IP地址和IP报文格式，以便进行IP寻址
    * 配置复杂 IP地址、默认网关、子网掩码、NAT等
    * 安全问题
    * 路由表膨胀
    * 地址枯竭(主要原因)
    * 移动性支持不足

IPV6

    * 支持几十亿台主机
    * 提供更好安全性
    * 简化协议
    * 缩减路由表的规模
    * 更加关注服务类型
    * 允许新老协议共存多年
    提出IPV6的组织：IETF

5.7 IPV6地址

IPV6：

    *由128bit构成，表示为32位0x，如0020:212D:FFEE:3122:3412:0000:1234:5678
    网络位数x在其后跟 /x
    * 省略全0可以写成::  ---  同一IP有不同表示方法
    * IPV6地址分为单播地址、组播地址、任波地址和特殊地址

特殊地址：

|地址类型|二进制前缀|IPV6标识|用途|
|:--:|:--:|:--:|:--:|
|未指定|00..0(128bit)|::/128|未分配状态、默认路由|
|环回地址|00..1(127bit)|::/128|本机|
|组播地址|11111111|FF00::/8||
|链路本地地址|1111111010|FE80::/10|用于本地链路通信|
|网点本地地址|1111111011|FE90::/10|用于站点内，类似私人地址|

子网规划

    较为简便，一个/48网络可以网络位的后面32bit作为子网规划，能够支持非常多子网

5.8 IPV6分组

IPV6头部(固定头)：

    IPV4分组：头部(最小20bytes) + 数据段, 总长度最大65535bytes
    IPV6分组：头部(40bytes) + 扩展头1 + 扩展头2 + ... + 数据段，总长度最大65535bytes

    流是从一个特定源向一个特定（单播或多播）目的地的包序列

|内容|大小|说明|
|:--:|:--:|:--:|
|协议版本|4bit|IPV4:0100 IPV6:0110|
|业务等级|8bit|分组的重要程度|
|流标记|20bit|流标签可用来标记特定流的报文|
|净荷长度|16bit||
|下一个头|8bit|扩展头，如果没有，为17/6 UDP/TCP|
|跳数限制|8bit||
|source|128bit|源IP|
|destination|128bit|目的IP|

相比IPV4的变化：

    修改：
    * IP地址32bit --- 128bit
    * Time To Live --- Hop Limit 叫法变了
    * Protocol --- Next Header 协议增强为了下一个头的标记
    * Type of Service --- Traffic Class 服务类型变为业务等级

    增加：
    * Flow Label 流标签

    删除：
    * 数据分段相关的标识符、标志、分段偏移量
    * IP选项
    * 报头校验和
    * 报头长度

5.9 IPV6过渡技术

三个阶段：

    * IPV4 + IPV6孤岛
    * IPV4 + IPV6分庭抗礼
    * IPV6 + IPV4孤岛

三类基本过渡技术(RFC1933):

    * 双协议栈(dual stack) --- 网络设备、网络系统必须有双协议栈支持
    * 隧道技术(tunnel) --- 将IPV6数据作为纯数据封装在IPV4数据报中，由IPV4传输
    * 地址转换技术(network address translation) --- 在以上二者均不可使用时可用，纯IPV4和IPV6的通信

5.10 路由(表)从何而来

路由器收到分组之后的动作：

    * 打开分组，提取目的IP地址
    * 查找路由表，使用子网掩码进行AND操作
    * 重新封装，转发 

路由表的由来：直连路由、静态路由、动态路由

直连路由：

    设备连接在一台路由器上，直接发现

静态路由：

    管理员手工配置
    默认/缺省路由是一种常见的静态路由，是默认的路径，找不到路时从这里通过
    好处：
    * 避免错误丢包
    * 缩减路由表的规模
    * 减少路由器的运行负担
    dos中输入 route print 可以看到主机路由表

动态路由：

由**路由选择协议**动态地建立、更新和维护的路由，适合大型的、经常变动的网络，需要维护开销，减少了网络管理员的负担

路由选择算法：

    是网络层软件的一部分，负责选择最优的传输路径
    主要有距离矢量路由选择协议(DV)和链路状态路由选择协议(LS)

度量路径的优劣：

|项目|说明|
|:--:|:--:|
|路径长度|从源到目的的hop数|
|可靠性|误码率|
|延迟|从源到目的的时间|
|带宽|链路最大传输流量|
|负载|网络资源(如路由器CPU)使用率|
|通信代价|线路费用|

    最优化原理：如果router J在I到K的最优路径上，则J到K的最优路径也同样在这条路径上
    沉落树(sink tree):从所有目的到源的最优路径形成的树，树根是源
    
5.11 距离矢量路由选择协议

DV(distance vector):

    * D-V算法是动态的和分布式的，常被用于小型网络，RIP是经典的DV
    * RIP: routing information protocol,路由选择信息协议,1988,RFC1058
    * 在早期互联网中广泛使用的始终路由选择协议

DV工作原理：

    * 维护：每个路由器维护一个D向量和一个S向量，D向量的每个分量表示路由器到第i个路由器的最短距离，S向量表示对应最短路径上的下一跳
    * 交换：邻居路由器交换矢量信息
    * 更新：根据收到的矢量信息更新路由表 

DV的特点：

    * 简单！
    * 交流的信息大
    * 信息交流较慢，可能导致路径信息不一致
    * 收敛慢，不适合大型网络

5.12 路由信息协议(RIP)

主要特点：
    
    * RIP是典型的DV路由选择协议
    * 采用跳数作为度量(metric)
    * 度量超过15hop，目的被认为不可达
    * 默认每30s交换一次矢量信息

缺点：

    * 不能到达度量超多15条的地址
    * RIP的度量以hop为单位，无法反应真是的网络状况
    * 度量计数到无穷、收敛慢等问题

5.13 RIP为什么会衰落？

路由环的形成：

    A --- B --- C --- 40.0.0.0
    2 --- 1 --- 0 
    如果C --- 40.0.0.0之间出问题了：
    A --- B --- C -x- 40.0.0.0
    2 --- 1 --- 2 (C不可直接到源机，询问B得到2)
    2 --- 3 --- 2 (B更新)
    4 --- 3 --- 2 (A更新)
    ...
    如果不定义hop最大值，将一直进行下去

解决方法：

    * 水平分割
        禁止B向C提供关于此信宿的信息
    * 毒性逆转
        出问题之后将C的矢量置为∞
    * 抑制定时器
        出问题后启动定时器
        如果在时间到之前恢复通路，关闭定时器
        收到来自B的更短路径值，更新路由表并关闭定时器
        没有以上两种情况，更新路由为信宿不可达
    * 触发更新
        不等待更新周期的到来，出故障之后立即进行传递

实验 路由器的设置

```c
> enable // 进入超级模式
> configure terminal
> hostname NAME // 修改名称
> interface fa0/0 //修改这个0/0接口
> ip address 192.168.0.1 255.255.255.0 //设置网关(路由器)和子网掩码
> no shutdown // 保存并应用
```
5.14 链路状态路由选择协议

链路状态路由(link state):

    * 发现 它的邻居节点们，了解它们的网络地址
    * 设置 到它的每个邻居的成本度量
    * 构造 一个分组，包含它所了解到的所有信息
    * 发送 这个分组给所有其他的路由器
    * 计算 到每个路由器的最短路径

    发现邻居：在点到点线路发送特别的HELLO分组，收到该分组的路由器回送包含自己名字(unique)的应答

    设置链路成本：发送一个ECHO分组，另一端回送一个应答，多次重复取得延迟估计值

    构造链路装填分组：包含发送方ID、序列号、年龄、邻居列表、到邻居的度量
    构造分组的时机：周期性构造或者当特定事件(例如某个路由器down掉)发生时

    发送链路状态分组：每一个分组包含一个序列号，序列号始终递增，路由器记录下它看到的所有(源，序列号)对
    
    计算新的路由路径：使用最短路径算法(如dijkstra算法)求出最短路径，安装在路由表中

当一个分组到来时的处理方法：

    * 分组是新的(源未被记录)，flooding 泛洪
    * 分组重复(源记录在案)，更新该源对应的记录，抛弃旧的记录
    * 分组过时(同源的序列号小于已记录的序列号)，抛弃

    出现的问题：
    * 序列号回转 --- 使用32bit的序列号，空间足够
    * 如果一台路由器崩溃后恢复，分组序列号从0开始，新分组始终被当做旧分组
    * 序列号发生错误
    --- 分组中的年龄属性每秒减1，当年龄为0时，来自该源的路由信息被丢弃，解决了这两种问题
    
    其他改进：
    * 在路由器中设置一个保留区，先对到来的数据进行比较再做下一步
    * 所有链路状态分组都要被确认
    
LS路由算法的特点

|优点|缺点|
|:--:|:--:|
|每个路由器认识一致|路由器需要较大存储空间|
|收敛快|计算负担大|
|适合大型网络使用||

5.15 单区域OSPF

OSPF(open shortest path first)开放的路径优先

    使用带宽作为度量值、应用广泛、无路由子环
    必须划分区域，所有子区域连接到骨干区域上

单区域OSPF

    RouterID：一个32bit无符号整数，标记区域内路由器的id
    协议号：IP报头中OSPF协议号为89
    TTL=1：通常不转发

OSPF分组

    1. HELLO 与邻居建立毗邻关系
    2. DD 数据库描述包 包含链路数据库内容摘要
    3. LSR 链路状态请求包  请求完整的链路状态分组
    4. LSD 链路状态更新包  发送完整的链路状态分组
    5. LSA 链路状态确认包  确认

OSPF运行步骤：

    1. 建立路由器的毗邻关系
        rA: HELLO        DD    DD    LSR     LSA  ...
        rB:       HELLO     DD    DD     LSD     ...
    2. 选举DR和BDR
        DR指导思想：选举制、终身制、世袭制(给BDR)
    3. 发现路由
    4. 选择最佳路由
    5. 维护路由信息

为何要选举DR和BDR？

    n个路由器需要同步，如果建立一对一的拓扑关系，需要交换 n*(n-1)/2 次
    选举DR可以将关系变为星型拓扑，交换n次即可，时间复杂度下降了O(n)

OSPF克服了路由环

    * 每一条LSA标记了生成者，其他路由器只负责传送，不会造成错误理解
    * 路由计算算法SPF(dijkstra)，计算的是单向不可回复路径
    * 区域之间通过规定骨干区域避免

5.16 无类域间路由CIDR

CIDR(classless interdomain routing)

    * 基本思想是分配IP地址时不再以类别分配，而是以地址块的形式(按需分配)
    缓解了IP地址枯竭的趋势
    例如194.24.6.112，子网掩码为255.255.248.0，则相应的子网络为194.24.00000 000.0
    该子网中网络位有21位，主机IP有2048个
    * 路由表项中有32bit的子网掩码
    * 当分组到来时，分组目标IP与路由表项的子网掩码进行AND操作，使用子网掩码最长的表项(最接近目的)
    
路由聚合

    只有连续的块地址才能聚合成一个超网
    子网分配的逆过程
    好处：缩减路由表的规模、隔离路由翻动(down/set)
    聚合例子：
    200.199.48.0/24  200.199.49.0/24  200.199.50.0/24  200.199.51.0/24 进行聚合
    将48~51表示为二进制形式：00110000 00110001 00110010 00110011
    掩码数为16+6 = 22位，起始地址为200.199.48.0，故聚合后的超网为200.199.48.0/22

5.17 网络地址翻译NAT

NAT/PAT

    NAT(network address translation)私有IP和公有IP的转换
    PAT(port address translation)将多个私有IP映射到一个公有IP的不同端口
    思路差不多，私网访问公网时转化为合法的global地址
    NAT能维持一个地址转换表，在数据到来时转发出去
    NAT转换了数据报文的端口地址

NAT的优缺点

    优点：
    * 节省了公用IP地址
    * 提供了内部网访问外网的灵活性
    * 有一定保密性
    缺点：
    * 影响了部分协议和应用
    * 增加了网络延时
    * NAT转换设备的性能可能成为网络性能的瓶颈
    * 影响了路由追踪工具的使用

5.18 互联网控制消息协议

ICMP(internet control message protocol)

    ICMP用来向源(通常)报告IP分组的丢包、拥塞、延迟、抖动等
    ICMP也用于测试网络

ICMP消息

    ICMP消息封装在IP分组中，其IP报头的协议字段为0x01，ICMP分组数据分为头标和数据
    头标包含类型、代码和校验和，类型和代码用来标识是何种问题引发ICMP

ICMP应用

    ping命令：
        源向目的站点发送一个包含任选数据的ICMP回声请求报文，如果目的站点收到则回发一个ICMP回声应答报文，
        源收到该应答报文，且任选数据相同，认为目的可达

|作用|命令|
|:--:|:--:|
|TCP/IP是否正常|ping 127.0.0.1|
|网络设备是否正确|ping 本机IP|
|对外连接的路由|ping 默认网关|
|与某台设备的通畅情况|ping IP|
|检查DNS设置|ping 网址|
|DNS反向查询|ping -a IP地址|

    tracert命令：
        通过ICMP超时报文获取一张从源到目的的途径路由器列表
        源向目的发送一个TTL1-n的IP报文，根据收到的ICMP超时报文判断路由器的地址信息，n最大为30
        如： tracert www.sina.com.cn
    
    PMTU (path maximum trasmission unit):
        最大传输单元
        源向路径中的路由器发送分组，如果MTU大了，路由器返回一个ICMP，源减小分组大小，继续发送到下一个路由器
        ...直到得到路径中最小的MTU

5.19 地址解析协议ARP

ARP(address resolution protocol)

    找到一个给定IP地址所对应的MAC地址

ARP请求

    * 请求帧：
    先导字段 + 11(以太网) + 目的地址 + 源地址 + 类型 + 数据 + 校验和
    62bit             ff:ff:ff:ff:ff:ff       0806
    请求帧在LAN中广播，应答帧采用单播

    * 提高效率：
    缓存ARP结果
    在ARP请求中包括源机的IP-MAC对
    每台机器启动时广播它的IP-MAC对，免费ARP如果收到应答，则IP地址冲突
    (免费ARP中source IP == target IP)

    * 如果目的机和源机不在同一个子网，则通过默认网关转发ARP
      source --  gateway  -- dest
      |___________|  |_________|
       对应一个ARP     另一个ARP

ARP表

    IP地址到MAC地址的映射表
    为了减少ARP请求的次数，每个设备都有ARP表，包括路由器
    dos 采用 arp -a 查看arp表信息; arp -d IP 删除记录; arp -s IP 添加记录

ARP欺骗

    由于ARP查找是广播，不是目的的主机收到ARP请求后也可以向源发送ARP信息
    方案：
    静态ARP
    不马上写ARP缓存
    ARP服务器...

5.20 拥塞控制

拥塞的度量

    因缺乏缓存空间而丢弃的分组百分比
    平均队列长度
    超时和重传的分组数量 --- 数值越大则拥塞程度越大
    分组延迟的平均值、标准方差

控制拥塞的方法

    引起拥塞的根源：负载 > 资源
    故解决方法是增加资源或者降低负载

抑制分组和逐跳抑制分组
    
    抑制分组：
    路由器给源发回一个抑制分组，并标明分组的目标地址，源机收到后以一定百分比减低发现该目标的流量，
    并在一定时间内不再处理抑制分组，以免流量下降太多。

    逐跳抑制分组：
    当网络速度很高或者路由器离源机距离很远时，给源发送抑制分组并不鞥很好地起作用，因为反应太慢
    逐跳抑制使路径上的每个路由器均采取相应的措施，付出的代价是上游路由器需要更多缓存空间

载荷脱落

    解决拥塞最极端/最有效的方法
    丢弃分组的选择：
    * 随机丢弃
    * 丢弃新到达的 -- 适合文件传输类
    * 丢弃早到达的 -- 适合多媒体类
    * 丢弃不太重要的 -- 适合分组已经标明优先级的

随机早期检验(RED random early detact)

    * 在情况恶化之前就开始丢弃分组
    * 当队列长度超过阈值时，采取相应措施

5.21 流量整形

流量整形的目的

    调节数据传输的平均速率
    控制突发数据流，减少拥塞

漏桶算法

    * 每个网络接口有一个漏桶，即一个有限长度的内部队列
    * 当桶中有分组时，输出速率恒定，无分组时速率为0
    * 当一个分组到达时桶满了，分组被丢弃
    * 每一个tick,仅允许固定数量的分组发送
    该算法可将一个不稳定的流变为稳定流，抹平了突发尖峰，减少了发生拥塞的机会
    缺点是桶满后将丢弃分组，不能应对大量的突发数据

令牌桶算法

    * 大量数据突发时，允许加快到某种程度
    * 令牌桶中有令牌(token)，并以一定速率注入令牌
    * 分组要发送时必须取得令牌
    * 令牌桶允许积累令牌，最多可积累n个令牌(令牌桶容量)
    
实验 静态通达、RIP、OSOF

```c
/*设置路由器两端口的IP*/
> en
> configure terminal
> ...

// 静态通达,参数分别为待连网段默认网关、子网掩码、待连路由器ip
> ip route 192.168.8.0 255.255.255.0 192.168.5.5
// 取消静态通达
> no ip route 192.168.8.0 255.255.255.0 192.168.5.5

// 开启RIP,依次加入两个网段的默认网关
> router rip
> network 192.168.8.0
> network 192.168.5.0
// 取消RIP
> no router rip

// 开启OSPF
> router ospf 10
> network 192.168.8.0 0.0.0.255 area 0
> network 192.168.5.0 0.0.0.255 area 0
// 关闭OSPF
> no router ospf 10

// 路由器开启DHCP
> configure terminal
> service DHCP
> ip dhcp pool name /*命名地址池*/
> network 192.168.8.0 255.255.255.0
> default-router 192.168.8.1
// dns-server 192.168.8.1
> exit
// 配置不加入地址池的ip
> ipdhcpexcluded-address 192.168.8.200 192.168.8.254
// 查看路由状态
> show running-configure
```

## 第六章 传输层

-------------

6.1 传输层概述

基本介绍

    传输层是整个TCP/IP协议的核心
    传输层提供的是可靠的、高效的数据传输
    传输层的最终目的是为应用层提供高效、可靠且性价比高的服务
    完成这些任务的硬件或软件被称为传输实体
    服务分为：面向连接和无连接的服务(与网络层类似)

为何需要将传输层独立于网络层

    * 网络层运行在运营商提供的路由器上，用户无法真正控制它
    * 传输层让用户可以控制服务质量
    * 源语独立
    IP协议作用于主机到主机
    TCP/UDP协议作用于端到端(应用到应用)

特征

    协议数据单元：TPDU(transport protocol data unit)由实体封装，端到端传输
    TPDU被封装在分组中，由网络层交换
    分组被封装在frame中，由数据链路层交换

    协议：
    UDP(user datagram protocol)用户数据报协议
    TCP(transport control protocol)传输控制协议

6.2 用户数据报协议

概述

    UDP是一个无连接的服务，在传输过程中无需建立连接
    很多C/S应用如DNS会发送一个UDP请求
    不提供差错检测和可靠传输，但是简洁高效

数据段头

    源端口 + 目的端口 + 总长度(包含data) + 校验和 = 4Bytes

端口

    0-65535
    0-1023 用于公共应用
    1024-49151 用户端口，注册端口
    >49152 私人端口

6.3 通信模型

通信组

    通信五元组
    Source IP + Source Port +
    TCP+
    Destination IP + Destination Port

知名端口

|Port|Protocol|Useage|
|:--:|:--:|:--:|
|21|FTP|File transfer|
|23|Telnet|Remote login|
|25|SMTP|E-mail|
|69|TFTP|Trivial file tranfer protocol|
|79|Finger|Lookup information about a user|
|80|HTTP|World Wide Web|
|110|POP-3|Remote e-mail access|
|119|NNTP|Usenet news|

6.4 TCP数据段

TCP数据段结构

    Source Port + Destination Port +
    Sequence Number +
    Acknowledgement Number +
    TCP header length + ... + URG + ACK + PSH + RST + SYN + FIN + 
    Window size +
    Checksum + Urgent Pointer +
    Options(0 or more 32bits) +
    Data

段头标记：

    URG: Urgent 紧急数据，即使窗口为0
    ACK: 确认号有效/无效
    PSH: push,不需缓存
    RST: 重置连接
    SYN: 连接建立
    FIN: 释放连接

Window size：

    TCP中的流控，滑动窗口协议

6.5 TCP三次握手的建立

    Host1 SYN=1, ACK=0, seq=x
    Host2 SYN=1, ACK=1, seq=y, ack=x+1
    Host1 SYN=0, ACK=1, seq=x+1, ack=y+1

6.6 TCP连接释放

    Host1 FIN=1
    Host2 ACK=1
    Host1收到后释放连接
    Host2 FIN=1
    Host1 ACK=1
    Host2收到后释放连接
    为了避免两军对垒问题，挥手需要四次
    TCP协议是全双工的

杀死半开放连接

    如果一定时间内没有TPDU到达，自动释放
    如果这样，传输实体在发送一个TPDU时必须启动一个定时器，如果定时器超期，将发送一个哑TPDU，以免被断掉

6.7 TCP流控

TCP是全双工传输，通过window size进行流控

发送方

    采用Nagle's algorithm, 尽量不发送数据含量小的数据段，缓存应用层的数据，达到一定量再发送

接收方

    采用Clark's algorithm,
    不请求对方发送短数据段，延迟窗口变更信息，使接收缓冲区足够大

6.8 TCP拥塞控制

概述

    网络层也可以管理拥塞，但大多数繁重的任务由TCP完成，解决方案为减慢数据率
    分组守恒：当老分组离开之后才允许新分组注入网络
    TCP希望通过动态维护窗口大小实现这个目标

拥塞控制

    两个潜在问题：网络容量和接收者容量

    接收者窗口反映目前窗口的容量，容易控制
    拥塞窗口反映目前网络容量，难于控制

慢启动算法

    速率先指数增长，到达阈值的一半以上后线性增大

6.9 TCP定时器

重传定时器

持续定时器

    用于避免发生死锁
    为了避免win=xxx的数据段丢失，双方均处于等待状态
    方法为定时器超时后发送探测数据段(空白的)

TCP和UDP

    TCP
    可靠的传输方式
    可让应用程序简单化，程序员不必进行错误检查、修正工作

    UDP
    降低对计算机资源的需求
    本身提供了数据完整性的检测
    传递的并非关键性数据
    一对多方式，必须使用UDP

## 第七章 应用层

-------------

7.1 应用层概述

应用层特点
    
    最特殊的一层，没有上一层供它服务，直接服务于模型外的用户
    最靠近的一层，向应用程序提供网络通信

应用层Application

    TCP
    Telnet, FTP, HTTP, SMTP, XWin(windows远程连接linux), REXEC
    UDP
    DNS, SNMP, TFTP(简单文件传输), RPC(远程过程调用), NFS(网络文件系统)

重定向器
    
    A redirector (requester) will allow a local company to use network storage
    devices as if they were locally attached. This is done through the use of driver mappings.
    eg: from F:\ to \\server1\netiogon

7.2 域名系统DNS

    由于IP地址难于记忆且经常变动，于是出现了域名
    DNS是一个层次化的分布式数据库系统，提供域名解析服务

    域名服务器： 主机向本地域名服务器发送请求，如果本地也不知道，则向根域服务器请求

7.3 DNS解析

域名解析过程
    
    -> 当一个解析器收到一个域名查询时，它将该查询传递给本地的一个域名服务器
    -> 如果待查询的域名落在该名字服务器的管辖范围内，它将返回权威资源记录
        一个权威资源记录是指来自于管理该记录的权威机构，因此总是对的，它和缓存
        的记录不同，后者可能是过期的
    -> 如果被请求的域名是远程的，且本地没有关于他的消息，那么本地名字服务器向根域服务器发送一条查询次域的消息

    递归查询：本机和本地服务器之间
    迭代查询：本地服务器和根服务器之间
    优化方法：高速缓存(不具有权威性)

协议

    端口号53，使用UDP协议，报文超过512Bytes时使用TCP协议，主从服务器数据更新也使用TCP

7.4 电子邮件

7.5 万维网


